<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GeneAnno</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.6.2/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.6.2/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.js"></script>
    <script defer src="js/refseq_conversion.js"></script>
    <script defer src="js/ncbi_conversion.js"></script>
    <script defer src="js/hom_conversion.js"></script>

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 100%; margin: 16px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 10px; border-radius: 4px; width: 150px; margin-top: 15px; cursor: pointer;}
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
      #message textarea { width: 98%; height: 400px; font-size: 16px; padding: 5px}
      #box {display: none; max-width: 200px; position: absolute;}

      /*** Table Styles **/
      th {color:#D5DDE5; background:#1b1e24; font-size:12px; font-weight: 400; padding:8px; text-align:left; vertical-align:middle;}
      tr {color:black; font-size:12px; font-weight:normal;}
      tr:nth-child(odd) td {background:#EBEBEB;}
      td {background:#FFFFFF; padding:8px; text-align:left; vertical-align:middle; font-weight:300; font-size:12px;}
    </style>
  </head>
  <body>
    <div id="message"></div>
    <div id="box" />

    <script>

      let table = {}, snapshot, r

      $(document).mouseup((e) => {
          if (!$("#box").is(e.target) && $("#box").has(e.target).length === 0) $("#box").hide()
      });

      const box = (e, row, col, max=1) => {
        let html = ''
        if (table[row][col]) table[row][col].map((e,i) => {
          if (i<15) {
            html += `<td style="width: 200px; float: left; box-shadow: black 1px 1px 3px; background-color: ${perc2color(Math.min(e.value,max)/max*100)}"><span style="font-weight: 800">${(e.tvalue?e.tvalue:e.value).toFixed(2)+" "}</span>${e.name || "NA"}</td>`
          }
        })
        $('#box').html(html)
        if(e.clientX+200 <= $(window).width()) {
          $('#box').css({left: e.clientX+'px', top: e.clientY+'px'})
        } else {
          $('#box').css({left: (e.clientX-200)+'px', top: e.clientY+'px'})
        }
        $('#box').show()
      }

      const perc2color = (perc) => {
        let r, g, b = 0;
        if(perc < 50) {
          g = 255;
          r = Math.round(5.1 * perc);
        }
        else {
          r = 255;
          g = Math.round(510 - 5.10 * perc);
        }
        let h = r * 0x10000 + g * 0x100 + b * 0x1;
        return '#' + ('000000' + h.toString(16)).slice(-6);
      }

      document.addEventListener('DOMContentLoaded', async () => {


        refseq_convert = JSON.parse(refseq_convert)

        document.getElementById("message").innerHTML = '<h2>GeneAnno</h2><h1>Processing...</h1>'
        
        let genes = JSON.parse(localStorage.getItem('genes'))
        
        for(let gene of genes) {
          document.getElementById("message").innerHTML = `<h2>GeneAnno</h2><h1>Processing...(${gene})</h1>`
          table[gene] = {}

          //Refseq
          snapshot = await firebase.firestore().collection('refseq').where('name', '==', gene.toUpperCase()).get()
          r = []

          snapshot.forEach(doc => {
            let data = doc.data()
            let chr = refseq_convert.find(e => e.refseq_id == data.contig)
            if (!chr) return
            r.push({
              name: data.name,
              chr: chr.ucsc_id,
              contig: data.contig,
              start: data.start,
              end: data.end,
              type: data.biotype,
              strand: data.strand,
              synonym: data.synonym
            })
          })
          table[gene] = Object.assign(table[gene], r.sort((a,b) => a.contig > b.contig ? 1 : -1)[0])


          //ExAC
          snapshot = await firebase.firestore().collection('exac').where('gene', '==', gene.toUpperCase()).orderBy('pLI', 'desc').limit(1).get()
          r = []
          snapshot.forEach(doc => {
            let data = doc.data()
            table[gene] = Object.assign(table[gene], {
              pLI: data.pLI
            })
          })


          //DISEASE
          snapshot = await firebase.firestore().collection('disease_textmining').where('SYMBOL', '==', gene.toUpperCase()).orderBy('Confidence', 'desc').get()
          r = []
          snapshot.forEach(doc => {
            let data = doc.data()
            r.push({
              name: data.NAME,
              value: data.Confidence,
            })
          })
          table[gene] = Object.assign(table[gene], {tm: r})

          snapshot = await firebase.firestore().collection('disease_experiments').where('SYMBOL', '==', gene.toUpperCase()).orderBy('Confidence', 'desc').get()
          r = []
          snapshot.forEach(doc => {
            let data = doc.data()
            r.push({
              name: data.NAME,
              value: data.Confidence,
            })
          })
          table[gene] = Object.assign(table[gene], {exp: r})

          snapshot = await firebase.firestore().collection('disease_knowledge').where('SYMBOL', '==', gene.toUpperCase()).orderBy('Confidence', 'desc').get()
          r = []
          snapshot.forEach(doc => {
            let data = doc.data()
            r.push({
              name: data.NAME,
              value: data.Confidence,
            })
          })
          table[gene] = Object.assign(table[gene], {kl: r})


          //IMPC
          snapshot = await firebase.firestore().collection('impc').where('marker_symbol', '==', hom_convert[gene.toUpperCase()]).get()
          r = []
          snapshot.forEach(doc => {
            let data = doc.data()
            r.push({
              name: data.mp_term_name,
              value: data.p_value,
            })
          })
          r = r.filter((e, idx) =>
            idx === r.findIndex((t) => (
              t.name === e.name
            ))
          ).map(e => {
            e.value = -Math.log10(e.value)
            e.tvalue = e.value
            if(e.value>6) e.value = 6
            return e
          })
          table[gene] = Object.assign(table[gene], {ho: r.sort((a,b) => a.tvalue < b.tvalue ? 1 : -1)})


          //HumanBase
          if (ncbi_convert[gene.toUpperCase()]) {
            await fetch(`https://us-central1-geneanno.cloudfunctions.net/humanbase/?id=${ncbi_convert[gene.toUpperCase()]}`).then((response) => {
              return response.json();
            })
            .then((myJson) => {
              let data = myJson.sort((a,b) => a.score < b.score ? 1 : -1).slice(0,15)
              r = data.map(e => {
                e.name = e.term.title
                e.value = e.score
                return e
              })
              table[gene] = Object.assign(table[gene], {hb: r});
            });
          }


          //GTEx
          snapshot = await firebase.firestore().collection('gtex').where('Description', '==', gene.toUpperCase()).limit(1).get()
          r = []
          snapshot.forEach(doc => {
            let data = doc.data()
            delete data.Name
            delete data.Description
            Object.keys(data).map(e => {
              r.push({
                name: e,
                value: data[e]
              })
            })
          })
          table[gene] = Object.assign(table[gene], {gt: r.sort((a,b) => a.value < b.value ? 1 : -1)})
          

        }

        let tableHtml = `<table style="width:100%">`
        tableHtml += `<tr>
          <th>Name</th>
          <th>Chr</th>
          <th>Start</th>
          <th>End</th>
          <th>Type</th>
          <th>Strand</th>
          <th>Synonym</th>
          <th>pLI</th>
          <th>Textmining</th>
          <th>Experiments</th>
          <th>Knowledge</th>
          <th>Mouse</th>
          <th>Prediction</th>
          <th>GTEx</th>
          </tr>`
        Object.keys(table).map((row, idx) => {
          tableHtml += `<tr>
            <td>${table[row].name || genes[idx]}</td>
            <td>${table[row].chr}</td>
            <td>${table[row].start}</td>
            <td>${table[row].end}</td>
            <td>${table[row].type}</td>
            <td>${table[row].strand}</td>
            <td>${table[row].synonym}</td>
            
            <td style="background-color: ${perc2color(table[row].pLI?table[row].pLI/1*100:0)}">${table[row].pLI?table[row].pLI.toFixed(2):"NA"}</td>

            <td onclick="box(event, '${row}', 'tm', 5)" style="cursor: pointer; background-color: ${perc2color(table[row].tm[0]?table[row].tm[0].value/5*100:0)}">${table[row].tm[0]?table[row].tm[0].name:"NA"}</td>
            
            <td onclick="box(event, '${row}', 'exp', 5)" style="cursor: pointer; background-color: ${perc2color(table[row].exp[0]?table[row].exp[0].value/5*100:0)}">${table[row].exp[0]?table[row].exp[0].name:"NA"}</td>
            
            <td onclick="box(event, '${row}', 'kl', 5)" style="cursor: pointer; background-color: ${perc2color(table[row].kl[0]?table[row].kl[0].value/5*100:0)}">${table[row].kl[0]?table[row].kl[0].name:"NA"}</td>
            
            <td onclick="box(event, '${row}', 'ho', 6)" style="cursor: pointer; background-color: ${perc2color(table[row].ho[0]?table[row].ho[0].value/6*100:0)}">${table[row].ho[0]?table[row].ho[0].name:"NA"}</td>
            
            <td onclick="box(event, '${row}', 'hb')" style="cursor: pointer; background-color: ${perc2color(table[row].hb?table[row].hb[0].value/1*100:0)}">${table[row].hb?table[row].hb[0].name:"NA"}</td>
            
            <td onclick="box(event, '${row}', 'gt', ${Math.max(...table[row].gt.map(e => e.value))})" style="cursor: pointer; background-color: ${perc2color(table[row].gt[0]?table[row].gt[0].value/Math.max(...table[row].gt.map(e => e.value))*100:0)}">${table[row].gt[0]?table[row].gt[0].name:"NA"}</td>
            
            </tr>`
        })
        tableHtml += `</table>`

        document.getElementById("message").innerHTML = `
          <h2>GeneAnno</h2>
          <h1>Report</h1>
          <div id="table">${tableHtml}</div>
          <a target="_blank" onclick="alert('hi')">Download</a>
        `
      });
    </script>
  </body>
</html>
